START TRANSACTION;


DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230523103502_AddDeviceSetting') THEN
    ALTER TABLE "EMP_DETAIL" ADD "EMP_DEVICE_ID" varchar(255) NULL;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230523103502_AddDeviceSetting') THEN
    CREATE TABLE "DEVICE_LOG" (
        "ID" bigint GENERATED BY DEFAULT AS IDENTITY,
        "DEVICE_IP" varchar(255) NOT NULL,
        "IS_SUCCESS" boolean NOT NULL,
        "REMARKS" varchar(255) NOT NULL,
        "ERROR_MESSAGE" text NULL,
        "ERROR_TRACE" text NULL,
        "DATE" timestamp with time zone NOT NULL,
        CONSTRAINT "PK_DEVICE_LOG" PRIMARY KEY ("ID")
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230523103502_AddDeviceSetting') THEN
    CREATE TABLE "DEVICE_SETTINGS" (
        "ID" integer GENERATED BY DEFAULT AS IDENTITY,
        "DEVICE_MODEL" varchar(255) NOT NULL,
        "DEVICE_IP" varchar(255) NOT NULL,
        "PORT_NUMBER" integer NOT NULL,
        "CLEAR_DEVICE_LOG" boolean NOT NULL,
        "AttendanceMode" varchar(255) NOT NULL,
        "COMPANY_ID" integer NOT NULL,
        "CREATED_AT" timestamp with time zone NOT NULL,
        "UPDATED_AT" timestamp with time zone NOT NULL,
        CONSTRAINT "PK_DEVICE_SETTINGS" PRIMARY KEY ("ID"),
        CONSTRAINT "FK_DEVICE_SETTINGS_COMPANY_COMPANY_ID" FOREIGN KEY ("COMPANY_ID") REFERENCES "COMPANY" ("Company_Id") ON DELETE CASCADE
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230523103502_AddDeviceSetting') THEN
    CREATE INDEX "IX_DEVICE_SETTINGS_COMPANY_ID" ON "DEVICE_SETTINGS" ("COMPANY_ID");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230523103502_AddDeviceSetting') THEN
    INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
    VALUES ('20230523103502_AddDeviceSetting', '6.0.10');
    END IF;
END $EF$;
COMMIT;

START TRANSACTION;


DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230524064011_UpdateDeviceMapping') THEN
    ALTER TABLE "EMP_DETAIL" DROP COLUMN "EMP_DEVICE_ID";
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230524064011_UpdateDeviceMapping') THEN
    CREATE TABLE "EMP_DEVICE_CODE" (
        "Id" integer GENERATED BY DEFAULT AS IDENTITY,
        "EMP_ID" integer NOT NULL,
        "DEVICE_CODE" varchar(255) NOT NULL,
        "COMPANY_ID" integer NOT NULL,
        "CREATED_AT" timestamp with time zone NOT NULL,
        "UPDATED_AT" timestamp with time zone NOT NULL,
        CONSTRAINT "PK_EMP_DEVICE_CODE" PRIMARY KEY ("Id"),
        CONSTRAINT "FK_EMP_DEVICE_CODE_COMPANY_COMPANY_ID" FOREIGN KEY ("COMPANY_ID") REFERENCES "COMPANY" ("Company_Id") ON DELETE CASCADE,
        CONSTRAINT "FK_EMP_DEVICE_CODE_EMP_DETAIL_EMP_ID" FOREIGN KEY ("EMP_ID") REFERENCES "EMP_DETAIL" ("EMP_ID") ON DELETE CASCADE
    );
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230524064011_UpdateDeviceMapping') THEN
    CREATE INDEX "IX_EMP_DEVICE_CODE_COMPANY_ID" ON "EMP_DEVICE_CODE" ("COMPANY_ID");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230524064011_UpdateDeviceMapping') THEN
    CREATE INDEX "IX_EMP_DEVICE_CODE_EMP_ID" ON "EMP_DEVICE_CODE" ("EMP_ID");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230524064011_UpdateDeviceMapping') THEN
    INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
    VALUES ('20230524064011_UpdateDeviceMapping', '6.0.10');
    END IF;
END $EF$;
COMMIT;

START TRANSACTION;


DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "DEVICE_LOG" DROP COLUMN "DEVICE_IP";
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "ATTENDANCE_LOG_NO_DIRECTION" DROP COLUMN "DEVICE_IP";
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "ATTENDANCE_LOG_NO_DIRECTION" RENAME COLUMN "EMP_CODE" TO "DEVICE_CODE";
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "DEVICE_LOG" ADD "DEVICE_ID" integer NULL;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "ATTENDANCE_LOG_NO_DIRECTION" ADD "DEVICE_ID" integer NOT NULL DEFAULT 0;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    CREATE INDEX "IX_DEVICE_LOG_DEVICE_ID" ON "DEVICE_LOG" ("DEVICE_ID");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    CREATE INDEX "IX_ATTENDANCE_LOG_NO_DIRECTION_DEVICE_ID" ON "ATTENDANCE_LOG_NO_DIRECTION" ("DEVICE_ID");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "ATTENDANCE_LOG_NO_DIRECTION" ADD CONSTRAINT "FK_ATTENDANCE_LOG_NO_DIRECTION_DEVICE_SETTINGS_DEVICE_ID" FOREIGN KEY ("DEVICE_ID") REFERENCES "DEVICE_SETTINGS" ("ID") ON DELETE CASCADE;
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    ALTER TABLE "DEVICE_LOG" ADD CONSTRAINT "FK_DEVICE_LOG_DEVICE_SETTINGS_DEVICE_ID" FOREIGN KEY ("DEVICE_ID") REFERENCES "DEVICE_SETTINGS" ("ID");
    END IF;
END $EF$;

DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM "__EFMigrationsHistory" WHERE "MigrationId" = '20230526064328_UpdateAttendanceDeviceSettings') THEN
    INSERT INTO "__EFMigrationsHistory" ("MigrationId", "ProductVersion")
    VALUES ('20230526064328_UpdateAttendanceDeviceSettings', '6.0.10');
    END IF;
END $EF$;
COMMIT;

